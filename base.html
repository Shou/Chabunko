<!DOCTYPE html>

<html>

<head>

<title>Chabunko</title>

<!-- {{{ CSS -->

<style type=text/css>

html, body
    { padding: 0
    ; margin: 0
    ; font-family: %font
    ; font-size: %size
    ; background: %bg
    ; color: %fg
    }

a { color: %link }

input
    { color: %fg
    ; background: %panelbg
    ; border: none
    ; font-family: %font
    ; font-size: %size
    }

table
    { border-spacing: 0
    ; border-collapse: collapse
    }

table td
    { padding: 0 }

#log
    { padding: 2px
    ; display: table
    ; overflow: hidden
    }

#inputform
    { position: fixed
    ; bottom: 0
    ; left: 0
    ; display: block
    ; width: 100%
    }

#inputwrap
    { box-shadow: 0 0 5px %fg }

#input
    { overflow: hidden
    ; display: block
    ; width: 100%
    }

#input:hover
    { background: %hoverbg }

#self
    { color: %fg
    ; background: %panelbg
    ; margin: 0
    }

#self:hover
    { background: %hoverbg }

#usercount
    { color: %fg
    ; background: %panelbg
    ; margin: 0
    ; border-left: 1px solid %fg
    }

#userlist
    { position: fixed
    ; top: 0
    ; left: 0
    ; width: 100%
    ; background: %panelbg
    ; box-shadow: 0 0 5px %fg
    }

#userlist > *
    { margin-left: %size }

#settings
    { width: 100%
    ; height: 100%
    ; top: 0
    ; left: 0
    ; position: fixed
    ; background-color: rgba(0, 0, 0, 0.5)
    ; display: none
    }

#settingsform
    { display: block
    ; width: 80%
    ; height: 80%
    ; margin: 5% auto 0 auto
    ; padding: 16px
    ; border: 1px solid %fg
    ; background: %panelbg
    ; color: %fg
    ; overflow: auto
    }

#settings input[type="text"]
    { background-color: %bg
    ; border: 1px solid %fg
    ; color: %fg
    }

.timestamp
    { color: %info }

.nick
    { color: #bb88dd
    ; text-align: right
    ; padding: 0pt 8pt
    ; border-right: 1px solid %fg
    ; max-width: 100pt
    ; text-overflow: ellipsis
    ; overflow: hidden
    }

.botnick:before
    { content: "• " }

.message
    { padding: 0pt 9pt
    ; width: 100%
    }

span.line
    { display: table-row }

span.line:nth-child(odd)
    { background: %oddbg }

span.line:nth-child(even)
    { background: %evenbg }

span.line:hover
    { background: %hoverbg }

span.line > span
    { display: table-cell
    ; white-space: pre
    }

span.line > .message
    { white-space: pre-wrap }

.embed
    { max-height: 64px
    ; max-width: 100%
    }

.youtube
    { background-size: 64px auto
    ; background-position: center center
    ; background-repeat: no-repeat
    ; height: 20px
    ; width: 28px
    ; padding: 22px 18px
    }

.highlight
    { text-shadow: 0 0 3px %highlight, 0 0 3px %highlight }

%css
</style>

<!-- }}} -->

<!-- {{{ Javascript -->

<script type=text/javascript>

// nick :: String
var nick = "%nick"

// selfc :: String
var selfc = "%self"

// userlist :: [String]
var userlist = []

// history :: [String]
var history = []

// colors :: Object String String
var colors =
    { white: "%white", black: "%black", blue: "%blue", green: "%green"
    , red: "%red", darkred: "%darkred", darkmagenta: "%darkmagenta"
    , orange: "%orange" , yellow: "%yellow", lightgreen: "%lightgreen"
    , cyan: "%cyan", lightcyan: "%lightcyan", lightblue: "%lightblue"
    , magenta: "%magenta", gray: "%gray", lightgray: "%lightgray"
    }

// colorints :: Object String String
var colorints =
    { "00": "white", "01": "black", "02": "blue", "03": "green", "04": "red"
    , "05": "darkred", "06": "darkmagenta", "07": "orange", "08": "yellow"
    , "09": "lightgreen", "10": "cyan", "11": "lightcyan", "12": "lightblue"
    , "13": "magenta", "14": "gray", "15": "lightgray"
    }

var defaults =
    { "avatars-toggle": true
    , "sound": 1
    , "sound-volume": 50
    , "embed-toggle": true
    , "timestamp": 1
    , "colorize-toggle": true
    , "sound-url": "http://a.pomf.se/k70da.ogg"
    , "avatar-url": ""
    , "nick-length": 10
    , "font-size": 9
    }

var ws = null


// connect :: IO ()
function connect(){
    ws = new WebSocket("ws://nitori.shou.io:8088/")

    ws.onopen = function(){
        console.log("Connected!")

        ws.send("name " + nick)
        ws.send("req 0")
        ws.send("list")
        ws.send("opt avatar-url")
    }

    ws.onerror = function(e){ console.log(e) }

    ws.onclose = function(e){
        ws = null
    }

    ws.onmessage = function(e){
        console.log(e.data)

        var cmds = e.data.split(' ')
        var dat = cmds.slice(1).join(' ')

        if (cmds.length < 1) console.log("Incorrect WebSocket data")

        else if (cmds[0] === "ping") ws.send("pong")

        else if (cmds.length < 2) console.log("Incorrect WebSocket data")

        else if (cmds[0] === "msgs") addMessage(JSON.parse(dat))

        else if (cmds[0] === "list")
            addUserlist(function(us) {
                return JSON.parse(dat)
            })

        else if (cmds[0] === "quit")
            addUserlist(function(us) {
                var nick = JSON.parse(dat)
                return us.filter(function(u) { return u !== nick })
            })

        else if (cmds[0] === "join")
            addUserlist(function(us) {
                var nick = JSON.parse(dat)
                return us.filter(function(u) { return u !== nick }).concat(nick)
            })

        else if (cmds[0] === "set") null

        else if (cmds[0] === "opt") null

        else if (cmds[0] === "opts") null

        else if (cmds[0] === "ban") banned(JSON.parse(dat))

        else if (cmds[0] === "warn") warning(JSON.parse(dat))

        else console.log("Unsupported command.")

    }
}

// flash :: String -> String -> Elem -> IO ()
function flash(s, c, e){
    e.style[s] = c
    setTimeout(function(){ e.style[s] = "" }, 1000)
}

// submit :: String -> IO ()
function submit(s){
    ws.send("msg " + s)

    var time = (new Date()).getTime() / 1000

    addMessage([{ nick: nick, time: time, msg: s }])

    history.push(s)
}

// nickColor :: String -> String
function nickColor(name){
    var rcolors = [ colors["green"], colors["red"], colors["darkmagenta"]
                  , colors["yellow"], colors["lightgreen"], colors["cyan"]
                  , colors["lightcyan"], colors["lightblue"], colors["magenta"]
                  ]
    var sum = 0

    for(var i = 0; i < name.length; i++) sum += name.charCodeAt(i)

    sum = sum % rcolors.length

    return rcolors[sum]
}

// nickOnly :: String -> String
function nickOnly(name){
    return name.replace(/^[~&@%+]/, "")
}

// embed :: String -> String
function embed(url){
    var la = "<a target=_blank href=" + url + ">"
    var mid = url
    var ra = "</a>"

    if (settingGet("embed-toggle", defaults["embed-toggle"])) {
        if (url.match(/(jpe?g|a?png|gif|bmp)(\?\S+)?$/i))
            mid = "<img class=embed src="
                + url
                + " alt="
                + url
                + ">"

        if (url.match(/youtu(\.be\/|be\.com\/watch\?v=\S+)/i))
            mid = "<img class='embed youtube'"
                + " src=http://www.youtube.com/yt/brand/media/image/YouTube-icon-full_color.png"
                + " style=background-image:url("
                + "http://img.youtube.com/vi/"
                + url.match(/(youtu\.be\/|v=)(\S{11})/)[2]
                + "/0.jpg) alt="
                + url
                + ">"
    }

    return la + mid + ra
}

// pad :: String -> String
function pad(xs){
    return xs.length < 2 ? '0' + xs : xs
}

// colorize :: String -> String
function colorize(co){
    var coreg = /^\u0003(?:(1[0-5]|0?\d)(?:,(1[0-5]|0?\d))?)/
    var nest = false
    var acc = ""

    for (var i = 0; i < co.length; i++) {
        var ma = co.substr(i).match(coreg)
        if (ma) {
            if (nest) acc += "</span>"
            var fg = "color:" + colors[colorints[pad(ma[1])]] + ';'
            var bg = ""
            if (ma[2] !== undefined)
                bg = "background-color:" + colors[colorints[pad(ma[2])]] + ';'

            acc += "<span style='" + fg + bg + "'>"

            i += ma[0].length - 1
            nest = true

        } else if (nest && co[i] === '\u0003') {
            acc += "</span>"
            nest = false

        } else acc += co[i]
    }

    if (nest) acc += "</span>"

    console.log("acc: " + acc)

    return acc
}

// stripColor :: String -> String
function stripColor(x){
    return x.replace(/\u0003((1[0-5]|0?\d)(,(1[0-5]|0?\d))?)?/g, "")
}

function action(msg){
    if (msg.match(/^\/me /i))
        msg = msg.replace("/me", "\u000305♥\u0003 "
                               + nick
                               + msg.replace(/^\/me/i, ""))

    return msg
}

// formatTime :: POSIXTime -> IO String
function formatTime(x){
    var t = settingGet("timestamp", defaults["timestamp"])
    var time = ""

    var D = new Date(x * 1000)
    var ho = pad(D.getHours() + "")
    var mi = pad(D.getMinutes() + "")
    var se = pad(D.getSeconds() + "")
    var wd = D.getDay()
    var da = D.getDate()
    var mo = D.getMonth()
    var ye = D.getFullYear()

    var days = [ "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" ]

    if  (t < 4)
        time = ho + ':' + mi

    if (t < 3)
        time += ':' + se

    if (t === 1)
        time = days[wd] + ' ' + time

    else if (t === 0)
        time = ye + '-' + mo + '-' + da + ' ' + time

    return time
}

// addMessage :: [Msg] -> IO ()
function addMessage(msgs){
    // Scroll height before new messages
    var wh = window.scrollY + window.innerHeight
    var bh = document.body.scrollHeight

    for (var i = 0; i < msgs.length; i++) {
        var line = document.createElement("span")
        var ts = document.createElement("span")
        var ni = document.createElement("span")
        var ms = document.createElement("span")

        line.className = "line"
        ts.className = "timestamp"
        ni.className = "nick"
        ms.className = "message"

        ts.textContent = formatTime(msgs[i].time)
        ts.name = msgs[i].time
        ts.title = (new Date(msgs[i].time * 1000)).toUTCString()
        ni.textContent = msgs[i].nick
        ms.textContent = msgs[i].msg

        line.appendChild(ts)
        line.appendChild(ni)
        line.appendChild(ms)

        var log = document.getElementById("log")
        log.appendChild(line)

        prepareLine(line)
    }

    if (msgs.length < 1) {
        console.log("Found no new messages!")

    } else {
        console.log("Found " + msgs.length + " new messages~")

        // Scroll
        var log = document.getElementById("log")

        console.log(wh + " >= " + (bh - 20))
        if (wh >= bh - 100) window.scrollBy(0, log.scrollHeight)
    }
}

// addUserlist :: ([String] -> [String]) -> IO ()
function addUserlist(f){
    userlist = f(userlist).sort()
    console.log(userlist.join(','))

    var us = document.getElementById("userlist")

    while (us.children.length > 0) us.removeChild(us.children[0])

    for (var i = 0; i < userlist.length; i++) {
        var span = document.createElement("span")
        span.textContent = userlist[i]
        span.style.color = nickColor(userlist[i])

        us.appendChild(span)
    }

    var usercount = document.getElementById("usercount")
    usercount.value = userlist.length
    flash("color", colors["cyan"], usercount)
}

// banned :: POSIXTime -> IO ()
function banned(ts) {
    flash("backgroundColor", colors["red"], document.getElementById("input"))

    var D = new Date(ts)

    // popup("You are banned until " + D.toUTCString())
}

// warning :: Int -> IO ()
function warning(n){
    if (n === 1) {
        flash( "backgroundColor"
             , colors["orange"]
             , document.getElementById("input")
             )

        var inp = document.getElementById("input")
        inp.value = history[history.length - 1]

        var lines = document.getElementsByClassName("line")


        var lastown
        for (var i = 0; i < lines.length; i++)
            if(lines[i].children[1].textContent === nick) lastown = lines[i]

        lastown.parentNode.removeChild(lastown)
    }
}

// prepareLine :: String -> IO ()
function prepareLine(line){
    var ts = line.children[0]
    var ni = line.children[1]
    var ms = line.children[2]

    // Display user nick
    if (ni.textContent === "Chabunko") {
        var msp = ms.innerHTML.split(": ")
        ms.innerHTML = msp.slice(1).join(": ")
        ni.textContent = stripColor(msp[0])
        ni.className += " botnick"
    }

    // Nick coloring
    if (nick === nickOnly(ni.textContent)) ni.style.color = selfc
    else if (settingGet("colorize-toggle", defaults["colorize-toggle"]))
        ni.style.color = nickColor(nickOnly(ni.textContent))


    // Nick max length
    var nl = settingGet("nick-length", defaults["nick-length"])
    if (ni.textContent.length > nl)
        ni.textContent = ni.textContent.substr(0, nl) + "…"

    // URLs and embedding
    ms.innerHTML = ms.innerHTML.replace(/https?:\/\/\S+/ig, embed)

    // Coloring
    ms.innerHTML = colorize(ms.innerHTML)

    // Word highlighting
    if (ms.textContent.match(RegExp( "(^|\s|[^a-zA-Z])"
                                   + nick
                                   + "(\s|$|[^a-zA-Z])", 'i'))
    && ni.textContent !== nick) {
        console.log("Highlight: " + nick)
        ms.className += " highlight"
        ni.className += " highlight"

        if (settingGet("sound", defaults["sound"]) === 1) {
            var audio = document.getElementById("audio")

            audio.src = settingGet("sound-url", defaults["sound-url"])
            audio.volume =
                settingGet("sound-volume", defaults["sound-volume"]) / 100
            audio.play()
        }
    }

    // Actions
    if (ms.innerHTML.match(/^\u0001ACTION/)) {
        var nii = ni.cloneNode()
        nii.className = ""
        ms.innerHTML = ms.innerHTML.replace(/^\u0001ACTION/, nii.outerHTML)
        ni.innerHTML = "<span style=color:" + colors["red"] + ">♥</span>"
    }

    // Sound
    if (settingGet("sound", defaults["sound"]) === 0
    && ni.textContent !== nick) {
        var audio = document.getElementById("audio")

        audio.src = settingGet("sound-url", defaults["sound-url"])
        audio.volume =
            settingGet("sound-volume", defaults["sound-volume"]) / 100
        audio.play()
    }
}

// settingGet :: String -> a -> IO a
function settingGet(s, fallback){
    try {
        return JSON.parse(localStorage[s])

    } catch(e) {
        return fallback
    }
}

// main :: IO ()
function main(){
    var iw = document.getElementById("inputform")

    // Form submit hijack!
    iw.addEventListener("submit", function(e){
        e.preventDefault()
        var msg = document.getElementById("input")

        if (msg.value.length > 0) {
            submit(msg.value)

            flash("backgroundColor", colors["green"], msg)

            msg.value = ""
        }
    })

    var inp = document.getElementById("input")

    // Typing outside input will put the chars into the input.
    document.body.addEventListener("keyup", function(e){
        if (e.ctrlKey || e.altKey);
        else if (e.keyCode >= 32 || e.keyCode == 8) {
            e.stopPropagation()
            inp.value += String.fromCharCode(e.keyCode)
            inp.focus()
        }
    })

    // Prevent Firefox from loading the search engine page
    // i HATE you firefox
    document.body.addEventListener("keydown", function(e){
        if (e.ctrlKey && e.keyCode === 75) {
            e.stopPropagation()
            e.preventDefault()
            return false
        }
    })

    // Input keyboard shortcuts
    inp.addEventListener("keyup", function(e){
        e.stopPropagation()
        if (e.keyCode === 13)
            if (this.value.length > 0) {
                submit(this.value)

                flash("backgroundColor", colors["green"], inp)

                this.value = ""
            }

        else if (e.ctrlKey && e.keyCode === 75)
            inp.value += '\u0003'
    })

    inp.addEventListener("keydown", function(e){
        e.stopPropagation()
        if (e.keyCode === 9) {
            var p = inp.selectionStart
        }
    })

    // Settings open/close events
    var slf = document.getElementById("self")
    var set = document.getElementById("settings")
    var sef = document.getElementById("settingsform")

    slf.addEventListener("click", function(e){
        console.log("Open settings!")
        set.style.display = "block"
    })
    set.addEventListener("click", function(e){
        console.log("Close settings!")
        set.style.display = ""
    })
    sef.addEventListener("click", function(e){
        e.stopPropagation()
    })

    // Setting input events and values
    var sinps = sef.getElementsByTagName("input")
    for (var i = 0; i < sinps.length; i++) {
        var f = function(e){}
        var g = function(e){}

        if (sinps[i].type === "checkbox") {
            f = function(e){
                localStorage[this.name] = JSON.stringify(this.checked)
            }

            sinps[i].checked = settingGet(sinps[i].name, defaults[sinps[i].name])

        } else if (sinps[i].type === "text") {
            f = function(e){
                localStorage[this.name] = JSON.stringify(this.value)
            }

            sinps[i].value = settingGet(sinps[i].name, defaults[sinps[i].name])

        } else if (sinps[i].type === "range") {
            f = function(e){
                localStorage[this.name] = JSON.stringify(parseInt(this.value))
            }

            g = function(e){
                this.title = this.value
            }

            sinps[i].value = settingGet(sinps[i].name, defaults[sinps[i].name])
            sinps[i].title = sinps[i].value

        } else if (sinps[i].type === "external") {
            f = function(e){
                ws.send("set " + this.name + ' ' + this.value)

                flash("backgroundColor", colors["cyan"], this)
            }

        }

        sinps[i].addEventListener("blur", f)
        sinps[i].addEventListener("change", g)
    }

    var ssels = sef.getElementsByTagName("select")
    for (var i = 0; i < ssels.length; i++) {
        ssels[i].addEventListener("change", function(e){
            console.log(this.name + ": " + this.selectedIndex)
            localStorage[this.name] = JSON.stringify(this.selectedIndex)
        })

        ssels[i].selectedIndex = settingGet(ssels[i].name, defaults[ssels[i].name])
    }

    if (settingGet("colorize-toggle", defaults["colorize-toggle"])) {
        var snick = document.getElementById("self")
        snick.style.color = nickColor(snick.value)
    }

    var size = settingGet("font-size", defaults["font-size"])
    document.body.style.fontSize = (size > 32 ? 32 : (size < 6 ? 6 : size)) + "pt"

    // Stupid browsers keep WebSockets open on refresh!
    window.onbeforeunload = function() {
        ws.onclose = function() {}
        ws.close()
    }

    // Userlist toggle
    var us = document.getElementById("usercount")
    us.addEventListener("click", function(e){
        var e = document.getElementById("userlist")
        if (e.style.display === "none") e.style.display = ""
        else e.style.display = "none"
    })

    // J-JAM IT IN
    connect()
}

// stime :: IO String
function stime(){
    var ts = document.getElementsByClassName("timestamp")
    return ts[ts.length - 1].name
}

</script>

<!-- }}} -->

</head>

<body>

<div id=wrap>

<div id=userlist></div>
<div id=log></div>

<input style=opacity:0>

</div>

<form id=inputform method=GET>
    <table id=inputwrap><tr>
        <td> <input type=button class=nick id=self value="%nick"> </td>
        <td style=width:100%>
            <input style=width:100% type=text id=input autocomplete=off name=msg>
        </td>
        <td> <input type=button class=usercount id=usercount value=0> </td>
    </tr></table>
</form>

<div id=settings>

<form id=settingsform method=GET>

    <span class=line>
        <span>Avatar: </span> <input type=external name=avatar-url>
    </span><span class=line>
        <span>Avatars? </span> <input type=checkbox name=avatars-toggle>
    </span><span class=line>
        <span>Sound: </span> <input type=text name=sound-url>
    </span><span class=line>
        <span>Sound? </span>
        <select name=sound>
            <option>Every message</option>
            <option>Highlighted messages</option>
            <option>Disabled</option>
        </select>
    </span><span class=line>
        <span>Volume </span> <input type=range min=0 max=100 name=sound-volume>
    </span><span class=line>
        <span>Embedding? </span> <input type=checkbox name=embed-toggle>
    </span><span class=line>
        <span>Timestamp: </span>
        <select name=timestamp>
            <option>Full date and time</option>
            <option>Day and time</option>
            <option>Time</option>
            <option>Time (without seconds)</option>
        </select>
    </span><span class=line>
        <span>Colorize nicks? </span> <input type=checkbox name=colorize-toggle>
    </span><span class=line>
        <span>Nick length: </span> <input type=range min=1 max=32 name=nick-length>
    </span><span class=line>
        <span>Font size: </span> <input type=range min=6 max=32 name=font-size>
    </span>

</form>

</div>

<audio id=audio>

<script> main() </script>

</body>

</html>

